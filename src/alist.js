import{createClient as t}from"webdav";import{Level as a}from"level";const o=new a("./database"),e="SCANNING_IS_DOING",n=async(t,a)=>{console.log("=======insert",t),await o.put(t,JSON.stringify(a))},r=async t=>{try{return await o.del(t)}catch(t){return void console.log("=======",t)}},s=async t=>{await o.put(e,String(t))},c=(t=500)=>new Promise((a=>setTimeout((()=>a(!0)),t)));var i={protocol:"http",host:"101.35.113.109",port:5244,username:"emby",password:"emby"};const l=()=>(console.log("=======config",i,"object"),new Promise((t=>t(i))));let w=null;const f=async(a,e=!0)=>{try{const s=await(async()=>{if(w)return w;const{protocol:a,port:o,host:e,username:n,password:r}=await l();return w=t(`${a}://${e}:${o}/dav`,{username:n,password:r}),w})(),i=await s.getDirectoryContents(a,{includeSelf:!0});if(!e)return void await n(a,i);const m=await(async t=>{try{const a=await o.get(t);return a?JSON.parse(a):[]}catch(t){return console.log("=======err",t),[]}})(a)||[];await n(a,i);const u=new Map,y=[];for(const t of m)u.set(t.filename,t);for(const t of i)if(a!==t.filename){const a=u.get(t.filename);a&&a.lastmod===t.lastmod?u.delete(t.filename):y.push(t)}for(const t of y)await c(1500),await f(t.filename,"directory"===t.type);for(const t of[...u.values()])await r(t.filename)}catch(t){return void console.error("获取目录内容或转换为XML时出错：",t)}},m=async(t,a=!0)=>{await(async()=>{try{const t=await o.get(e);return!!t&&t===String(!0)}catch(t){return[]}})()?console.log("===已有扫描正在处理中===="):(await s(!0),await f(t,!0),await s(!1),console.log("===扫描完成===="))},u=async(t,a)=>{const o=t.params[0]||"/";m(o,!0),a.send({code:0})},y=async()=>{await l(),await s(!1),m("/",!0)};export{y as initData,u as scanning,m as scanningHandler};
