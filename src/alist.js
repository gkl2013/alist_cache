import{createClient as t}from"webdav";import{Level as o}from"level";import a from"fs";import*as r from"path";import{fileURLToPath as e}from"url";const n=new o("./database"),s="SCANNING_IS_DOING",i=async(t,o)=>{console.log("=======insert",t),await n.put(t,JSON.stringify(o))},c=async t=>{try{return await n.del(t)}catch(t){return void console.log("=======",t)}},l=async t=>{await n.put(s,String(t))},f=(t=500)=>new Promise((o=>setTimeout((()=>o(!0)),t)));let m=null;function u(){let t=r.dirname(e(import.meta.url));for(;!a.existsSync(r.join(t,"package.json"));)t=r.dirname(t);return t}u();const w=()=>{const t=r.join(u(),"alist.json");return new Promise((o=>{if(m)return o(m);a.readFile(t,"utf8",((t,a)=>{if(t)console.error("读取配置文件失败：",t);else try{const t=JSON.parse(a);return console.log("读取到的配置内容：",t),m=t,o(t)}catch(t){console.error("解析配置文件内容出错：",t)}}))}))},p="directory";let d=null;const y=async(o,a=!0)=>{try{const r=await(async()=>{if(d)return d;const{protocol:o,port:a,host:r,username:e,password:n}=await w();return d=t(`${o}://${r}:${a}/dav`,{username:e,password:n}),d})(),e=await r.getDirectoryContents(o,{includeSelf:!0});if(!e||0===e.length)return;if(!a)return void await i(o,e);const s=await(async t=>{try{const o=await n.get(t);return o?JSON.parse(o):[]}catch(t){return console.log("=======err",t),[]}})(o)||[];await i(o,e);const l=new Map,m=[];for(const t of s)l.set(t.filename,t);for(const t of e)if(o!==t.filename){const o=l.get(t.filename);(!o||o.lastmod!==t.lastmod||o.lastmod===t.lastmod&&t.type===p)&&m.push(t)}for(const t of m)await f(1500),await y(t.filename,t.type===p);for(const[t]of l){e.find((o=>o.filename===t))||await c(t)}}catch(t){return void console.error("获取目录内容或转换为XML时出错：",t)}},g=async(t,o=!0)=>{await(async()=>{try{const t=await n.get(s);return!!t&&t===String(!0)}catch(t){return[]}})()?console.log("===已有扫描正在处理中===="):(await l(!0),await y(t,!0),await l(!1),console.log("===扫描完成===="))},h=async(t,o)=>{const a=t.params[0]||"/";g(a,!0),o.send({code:0})},S=async()=>{await w(),await l(!1),g("/",!0)};export{S as initData,h as scanning,g as scanningHandler};
