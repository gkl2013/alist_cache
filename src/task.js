import t from"node-cron";import{createClient as o}from"webdav";import{Level as r}from"level";import e from"fs";import*as n from"path";import{fileURLToPath as a}from"url";const s=new r("./database"),i="SCANNING_IS_DOING",c=async(t,o)=>{console.log("=======insert",t),await s.put(t,JSON.stringify(o))},l=async t=>{try{return await s.del(t)}catch(t){return void console.log("=======",t)}},f=async t=>{await s.put(i,String(t))},m=(t=500)=>new Promise((o=>setTimeout((()=>o(!0)),t)));let u=null;function w(){let t=n.dirname(a(import.meta.url));for(;!e.existsSync(n.join(t,"package.json"));)t=n.dirname(t);return t}w();const p="directory";let d=null;const y=async()=>{if(d)return d;const{protocol:t,port:r,host:a,username:s,password:i}=await(()=>{const t=n.join(w(),"alist.json");return new Promise((o=>{if(u)return o(u);e.readFile(t,"utf8",((t,r)=>{if(t)console.error("读取配置文件失败：",t);else try{const t=JSON.parse(r);return console.log("读取到的配置内容：",t),u=t,o(t)}catch(t){console.error("解析配置文件内容出错：",t)}}))}))})();return d=o(`${t}://${a}:${r}/dav`,{username:s,password:i}),d},g=async(t,o=!0)=>{try{const r=await y(),e=await r.getDirectoryContents(t,{includeSelf:!0});if(!e||0===e.length)return;if(!o)return void await c(t,e);const n=await(async t=>{try{const o=await s.get(t);return o?JSON.parse(o):[]}catch(t){return console.log("=======err",t),[]}})(t)||[];await c(t,e);const a=new Map,i=[];for(const t of n)a.set(t.filename,t);for(const o of e)if(t!==o.filename){const t=a.get(o.filename);(!t||t.lastmod!==o.lastmod||t.lastmod===o.lastmod&&o.type===p)&&i.push(o)}for(const t of i)await m(1500),await g(t.filename,t.type===p);for(const[t]of a){e.find((o=>o.filename===t))||await l(t)}}catch(t){return void console.error("获取目录内容或转换为XML时出错：",t)}},h=async(t,o=!0)=>{await(async()=>{try{const t=await s.get(i);return!!t&&t===String(!0)}catch(t){return[]}})()?console.log("===已有扫描正在处理中===="):(await f(!0),await g(t,!0),await f(!1),console.log("===扫描完成===="))},S=()=>{t.schedule("*/20 * * * *",(()=>{console.log("===定时任务启动===="),h("/",!0)}))};export{S as timeSchedule};
